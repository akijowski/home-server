#!/usr/bin/env bash

set -eo pipefail

TARGET_DIR=/usr/local/bin
PACKER_VERSION=1.11.2
PACKER_HOST=https://releases.hashicorp.com/packer
V_BINARY="$TARGET_DIR/packer_$PACKER_VERSION"

function checks() {
    if [[ -f "$V_BINARY" ]]; then
        echo "$V_BINARY already exists. Nothing to do."
        exit 0
    fi
}

function dl_packer_binary() {
    # later: https://developer.hashicorp.com/well-architected-framework/operational-excellence/verify-hashicorp-binary
    arch=$(uname -m)
    if [[ "$arch" == *"aarch64" ]]; then
        arch="arm64"
    fi

    os=$(uname -s)
    os="${os,,}"

    binary="packer_${PACKER_VERSION}_${os}_${arch}.zip"
    url="${PACKER_HOST}/${PACKER_VERSION}/${binary}"

    echo "$url"

    tmpdir=$(mktemp -d)

    pushd "$tmpdir"

    wget "$url"

    unzip "$binary"
    sudo mv packer "$V_BINARY"

    popd
    rm -rf "$tmpdir"
}

function set_symlinks() {
    sudo chown root:root "$V_BINARY"
    sudo ln -fsv "$V_BINARY" "$TARGET_DIR/packer"
}

function main() {
    checks
    dl_packer_binary
    set_symlinks
}

main "$@"
