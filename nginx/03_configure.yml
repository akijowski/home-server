---
- hosts: all
  become: true
  vars_files:
    - vars/nginx.yml

  tasks:
    - name: Install Nginx
      apt:
        name: nginx
        state: latest

    - name: Copy SSL key
      copy:
        src: ./ssl/proxmox.key
        dest: /etc/nginx/ssl/proxmox/pve.key
    
    - name: Copy SSL certificate
      copy:
        src: ./ssl/proxmox.pem
        dest: /etc/nginx/ssl/proxmox/pve.pem

    - name: Remove default site
      file:
        path: /etc/nginx/sites-enabled/default
        follow: yes
        state: absent

    - name: Copy Nginx config
      copy:
        src: "{{ item.local_path }}"
        dest: "{{ item.remote_path }}"
        owner: root
        group: root
        mode: '0644'
      loop: "{{ vhosts }}"

    - name: Link config
      file:
        path: "{{ item.enabled_path }}"
        src: "{{ item.remote_path }}"
        state: link
        owner: root
        group: root
        mode: '0644'
      loop: "{{ vhosts }}"

    - name: Enable Nginx in Systemctl
      ansible.builtin.systemd:
        name: nginx
        enabled: yes
        state: started

    - name: Allow Nginx in UFW
      community.general.ufw:
        rule: allow
        name: "Nginx Full"

    - name: Message
      debug:
        msg: Make sure to configure DNS to point to proxmox.home.lan
