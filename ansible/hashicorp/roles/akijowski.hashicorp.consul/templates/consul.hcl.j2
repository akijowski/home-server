{{ ansible_managed | comment }}

# https://developer.hashicorp.com/consul/docs/reference/agent/configuration-file

auto_reload_config = true
datacenter = {{ consul_dc_name | to_json }}

autopilot {
    min_quorum = {{ consul_retry_join_servers | length | to_json }}
}

{% if is_consul_bootstrap %}
bootstrap_expect = {{ consul_retry_join_servers | length | to_json }}
{% endif -%}

retry_join = {{ consul_retry_join_all | to_json }}
bind_addr = {% raw %}"{{ GetPrivateInterfaces | exclude \"type\" \"ipv6\" | include \"network\" \"10.10.10.1/24\" | limit 1 | attr \"address\" }}"
{% endraw %}
client_addr = {% raw %}"{{ GetPrivateInterfaces | exclude \"type\" \"ipv6\" | include \"network\" \"10.10.10.1/24\" | join \"address\" \" \" }} {{ GetAllInterfaces | include \"flags\" \"loopback\" | join \"address\" \" \" }}"
{% endraw %}
advertise_addr = {% raw %}"{{ GetPrivateInterfaces | exclude \"type\" \"ipv6\" | include \"network\" \"10.10.10.1/24\" | limit 1 | attr \"address\" }}"
{% endraw %}

data_dir = "{{ consul_data_dir }}"

server = {{ consul_agent_server | to_json }}

ui_config {
    enabled = true
}

raft_logstore {
    backend = "wal"
    verification {
        enabled = true
        interval = "5m"
    }
}
